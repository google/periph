language: go
sudo: false
go_import_path: periph.io/x/periph
go:
  - 1.7.6
    # Dear future me: if you touch this line, don't forget to update the
    # conditions below!
  - 1.11.4

# References:
# - https://docs.travis-ci.com/user/languages/go/
# - https://docs.travis-ci.com/user/conditional-builds-stages-jobs/
# - https://docs.travis-ci.com/user/build-stages/
stages:
  - name: before_script
  - name: short
    if: env(TRAVIS_GO_VERSION) = 1.7.6
  - name: full
    if: env(TRAVIS_GO_VERSION) != 1.7.6

before_script:
  - echo $TRAVIS_GO_VERSION
  - go get -t -v periph.io/x/periph/...

short:
  - go test ./...

full:
  - echo 'Check Code is well formatted'; ! gofmt -s -d . | read
  - echo 'Looking for external dependencies:'; go list -f '{{join .Imports "\n"}}' periph.io/x/periph/... | sort | uniq | grep -v ^periph.io/x/periph | xargs go list -f '{{if not .Standard}}- {{.ImportPath}}{{end}}'
  - echo 'Erroring on external dependencies:'; ! go list -f '{{join .Imports "\n"}}' periph.io/x/periph/... | sort | uniq | grep -v ^periph.io/x/periph | xargs go list -f '{{if not .Standard}}Remove {{.ImportPath}}{{end}}' | grep -q Remove
  - echo 'Erroring on /host depending on /devices:'; ! go list -f '{{.ImportPath}} depends on {{join .Imports ", "}}' periph.io/x/periph/host/... | sort | uniq | grep periph.io/x/periph/devices
  - echo 'Erroring on /conn depending on /devices:'; ! go list -f '{{.ImportPath}} depends on {{join .Imports ", "}}' periph.io/x/periph/conn/... | sort | uniq | grep periph.io/x/periph/devices
  - echo 'Erroring on /conn depending on /host:'; ! go list -f '{{.ImportPath}} depends on {{join .Imports ", "}}' periph.io/x/periph/conn/... | sort | uniq | grep periph.io/x/periph/host
  - bash -c 'set -e; echo "" > coverage.txt; for d in $(go list ./...); do go test -covermode=count -coverprofile=p.out $d; if [ -f p.out ]; then cat p.out >> coverage.txt; rm p.out; fi; done'
  - bash <(curl -s https://codecov.io/bash)
  - go test -race ./...
